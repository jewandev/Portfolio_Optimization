rets = na.omit(Return.calculate(prices))
ep = endpoints(rets, on = 'months')
print(ep)
i = lookback + 1
sub_price = prices[ep[i-lookback] : ep[i] , 1]
head(sub_price, 3)
wts = list()
lookback = 10
i = lookback + 1
sub_price = prices[ep[i-lookback] : ep[i] , 1]
head(sub_price, 3)
tail(sub_price, 3)
sma = mean(sub_price)
sma
wt = rep(0, 2)
wt[1] = ifelse(last(sub_price) > sma, 1, 0)
wt[2] = 1 - wt[1]
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
ep = endpoints(rets, on = 'months')
ep
wts[[i]]
wts = list()
lookback = 10
i = lookback + 1
sub_price = prices[ep[i-lookback] : ep[i] , 1]
head(sub_price, 3)
tail(sub_price, 3)
sma = mean(sub_price)
wt = rep(0, 2)
wt[1] = ifelse(last(sub_price) > sma, 1, 0)
wt[2] = 1 - wt[1]
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
wts[[i]]
print(ep)
wts = list()
lookback = 10
i = lookback + 1
sub_price = prices[ep[i-lookback] : ep[i] , 1]
sma = mean(sub_price)
wt = rep(0, 2)
wt[1] = ifelse(last(sub_price) > sma, 1, 0)
wt[2] = 1 - wt[1]
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
wts[[i]]
wts = list()
lookback = 10
i = lookback + 1
sub_price = prices[ep[i-lookback] : ep[i] , 1]
head(sub_price, 3)
tail(sub_price, 3)
sma = mean(sub_price)
wt = rep(0, 2)
wt[1] = ifelse(last(sub_price) > sma, 1, 0)
wt[2] = 1 - wt[1]
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
wts[[i]]
ep = endpoints(rets, on = 'months')
wts = list()
lookback = 10
for (i in (lookback+1) : length(ep)) {
sub_price = prices[ep[i-lookback] : ep[i] , 1]
sma = mean(sub_price)
wt = rep(0, 2)
wt[1] = ifelse(last(sub_price) > sma, 1, 0)
wt[2] = 1 - wt[1]
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
}
wts = do.call(rbind, wts)
Tactical = Return.portfolio(rets, wts, verbose = TRUE)
portfolios = na.omit(cbind(rets[,1], Tactical$returns)) %>%
setNames(c('매수 후 보유', '시점 선택 전략'))
par(family = 'AppleGothic')
charts.PerformanceSummary(portfolios,
main = "Buy & Hold vs Tactical")
wt
wt
t(wt)
glimpse(t(wt))
glimpse(wt)
glimpse(t(wt))
glimpse(wt[1])
glimpse(t(wt[1]))
wts[[i]]
wts = list()
lookback = 10
i = lookback + 1
sub_price = prices[ep[i-lookback] : ep[i] , 1]
head(sub_price, 3)
tail(sub_price, 3)
sma = mean(sub_price)
wt = rep(0, 2)
wt[1] = ifelse(last(sub_price) > sma, 1, 0)
wt[2] = 1 - wt[1]
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
wts[[i]]
ep = endpoints(rets, on = 'months')
wts = list()
lookback = 10
for (i in (lookback+1) : length(ep)) {
sub_price = prices[ep[i-lookback] : ep[i] , 1]
sma = mean(sub_price)
wt = rep(0, 2)
wt[1] = ifelse(last(sub_price) > sma, 1, 0)
wt[2] = 1 - wt[1]
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
}
wts = do.call(rbind, wts)
wts
wts
rets[,1]
Tactical$returns
Tactical
Tactical$returns
View(Tactical)
Tactical
head(Tactical)
head(Tactical, 10)
rets
wts
wt
charts.PerformanceSummary(portfolios,
main = "Buy & Hold vs Tactical")
turnover = xts(rowSums(abs(Tactical$BOP.Weight -
timeSeries::lag(Tactical$EOP.Weight)),
na.rm = TRUE),
order.by = index(Tactical$BOP.Weight))
chart.TimeSeries(turnover)
### 동적 자산배분 백테스트
library(quantmod)
library(PerformanceAnalytics)
library(RiskPortfolios)
library(tidyr)
library(dplyr)
library(ggplot2)
symbols = c('SPY', # 미국 주식
'IEV', # 유럽 주식
'EWJ', # 일본 주식
'EEM', # 이머징 주식
'TLT', # 미국 장기채
'IEF', # 미국 중기채
'IYR', # 미국 리츠
'RWX', # 글로벌 리츠
'GLD', # 금
'DBC'  # 상품
)
getSymbols(symbols, src = 'yahoo')
prices = do.call(cbind, lapply(symbols, function(x) Ad(get(x)))) %>%
setNames(symbols)
rets = Return.calculate(prices) %>% na.omit()
wt_zero
for (i in (lookback+1) : length(ep)) {
sub_ret = rets[ep[i-lookback] : ep[i] , ]
cum = Return.cumulative(sub_ret)
K = rank(-cum) <= 5
covmat = cov(sub_ret[, K])
wt = wt_zero
wt[K] = optimalPortfolio(covmat,
control = list(type = 'minvol',
constraint = 'user',
LB = rep(0.10, 5),
UB = rep(0.30, 5)))
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
}
ep = endpoints(rets, on = 'months')
wts = list()
lookback = 12
wt_zero = rep(0, 10) %>% setNames(colnames(rets))
for (i in (lookback+1) : length(ep)) {
sub_ret = rets[ep[i-lookback] : ep[i] , ]
cum = Return.cumulative(sub_ret)
K = rank(-cum) <= 5
covmat = cov(sub_ret[, K])
wt = wt_zero
wt[K] = optimalPortfolio(covmat,
control = list(type = 'minvol',
constraint = 'user',
LB = rep(0.10, 5),
UB = rep(0.30, 5)))
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
}
charts.PerformanceSummary(GDAA$returns, main = '동적자산배분')
wts %>% fortify.zoo() %>%
gather(key, value, -Index) %>%
mutate(Index = as.Date(Index)) %>%
mutate(key = factor(key, levels = unique(key))) %>%
ggplot(aes(x = Index, y = value)) +
geom_area(aes(color = key, fill = key),
position = 'stack') +
xlab(NULL) + ylab(NULL) +  theme_bw() +
scale_x_date(date_breaks="years", date_labels="%Y",
expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.title = element_text(hjust = 0.5,
size = 12),
legend.position = 'bottom',
legend.title = element_blank(),
axis.text.x = element_text(angle = 45,
hjust = 1, size = 8),
panel.grid.minor.x = element_blank()) +
guides(color = guide_legend(byrow = TRUE))
charts.PerformanceSummary(GDAA$returns, main = '동적자산배분')
wts %>% fortify.zoo() %>%
gather(key, value, -Index) %>%
mutate(Index = as.Date(Index)) %>%
mutate(key = factor(key, levels = unique(key))) %>%
ggplot(aes(x = Index, y = value)) +
geom_area(aes(color = key, fill = key),
position = 'stack') +
xlab(NULL) + ylab(NULL) +  theme_bw() +
scale_x_date(date_breaks="years", date_labels="%Y",
expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.title = element_text(hjust = 0.5,
size = 12),
legend.position = 'bottom',
legend.title = element_blank(),
axis.text.x = element_text(angle = 45,
hjust = 1, size = 8),
panel.grid.minor.x = element_blank()) +
guides(color = guide_legend(byrow = TRUE))
wts
wts %>% fortify.zoo() %>%
gather(key, value, -Index) %>%
mutate(Index = as.Date(Index)) %>%
mutate(key = factor(key, levels = unique(key))) %>%
ggplot(aes(x = Index, y = value)) +
geom_area(aes(color = key, fill = key),
position = 'stack') +
xlab(NULL) + ylab(NULL) +  theme_bw() +
scale_x_date(date_breaks="years", date_labels="%Y",
expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.title = element_text(hjust = 0.5,
size = 12),
legend.position = 'bottom',
legend.title = element_blank(),
axis.text.x = element_text(angle = 45,
hjust = 1, size = 8),
panel.grid.minor.x = element_blank()) +
guides(color = guide_legend(byrow = TRUE))
wts %>% fortify.zoo() %>%
gather(key, value, -Index) %>%
mutate(Index = as.Date(Index)) %>%
mutate(key = factor(key, levels = unique(key))) %>%
ggplot(aes(x = Index, y = value)) +
geom_area(aes(color = key, fill = key),
position = 'stack') +
xlab(NULL) + ylab(NULL) +  theme_bw() +
scale_x_date(date_breaks="years", date_labels="%Y",
expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.title = element_text(hjust = 0.5,
size = 12),
legend.position = 'bottom',
legend.title = element_blank(),
axis.text.x = element_text(angle = 45,
hjust = 1, size = 8),
panel.grid.minor.x = element_blank()) +
guides(color = guide_legend(byrow = TRUE))
rets = Return.calculate(prices) %>% na.omit()
ep = endpoints(rets, on = 'months')
wts = list()
prices = do.call(cbind, lapply(symbols, function(x) Ad(get(x)))) %>%
setNames(symbols)
rets = Return.calculate(prices) %>% na.omit()
ep = endpoints(rets, on = 'months')
wts = list()
lookback = 12
wt_zero = rep(0, 10) %>% setNames(colnames(rets))
for (i in (lookback+1) : length(ep)) {
sub_ret = rets[ep[i-lookback] : ep[i] , ]
cum = Return.cumulative(sub_ret)
K = rank(-cum) <= 5
covmat = cov(sub_ret[, K])
wt = wt_zero
wt[K] = optimalPortfolio(covmat,
control = list(type = 'minvol',
constraint = 'user',
LB = rep(0.10, 5),
UB = rep(0.30, 5)))
wts[[i]] = xts(t(wt), order.by = index(rets[ep[i]]))
}
wts = do.call(rbind, wts)
GDAA = Return.portfolio(rets, wts, verbose = TRUE)
charts.PerformanceSummary(GDAA$returns, main = '동적자산배분')
wts %>% fortify.zoo() %>%
gather(key, value, -Index) %>%
mutate(Index = as.Date(Index)) %>%
mutate(key = factor(key, levels = unique(key))) %>%
ggplot(aes(x = Index, y = value)) +
geom_area(aes(color = key, fill = key),
position = 'stack') +
xlab(NULL) + ylab(NULL) +  theme_bw() +
scale_x_date(date_breaks="years", date_labels="%Y",
expand = c(0, 0)) +
scale_y_continuous(expand = c(0, 0)) +
theme(plot.title = element_text(hjust = 0.5,
size = 12),
legend.position = 'bottom',
legend.title = element_blank(),
axis.text.x = element_text(angle = 45,
hjust = 1, size = 8),
panel.grid.minor.x = element_blank()) +
guides(color = guide_legend(byrow = TRUE))
GDAA$turnover = xts(
rowSums(abs(GDAA$BOP.Weight -
timeSeries::lag(GDAA$EOP.Weight)),
na.rm = TRUE),
order.by = index(GDAA$BOP.Weight))
chart.TimeSeries(GDAA$turnover)
fee = 0.0030
GDAA$net = GDAA$returns - GDAA$turnover*fee
cbind(GDAA$returns, GDAA$net) %>%
setNames(c('No Fee', 'After Fee')) %>%
charts.PerformanceSummary(main = 'GDAA')
Tactical$turnover = xts(
rowSums(abs(Tactical$BOP.Weight -
timeSeries::lag(Tactical$EOP.Weight)),
na.rm = TRUE),
order.by = index(Tactical$BOP.Weight))
wts = do.call(rbind, wts)
GDAA = Return.portfolio(rets, wts, verbose = TRUE)
charts.PerformanceSummary(GDAA$returns, main = '동적자산배분')
portfolios = na.omit(cbind(GDAA$returns, Tactical$returns)) %>%
setNames(c('동적 자산 배분', '시점 선택 전략'))
charts.PerformanceSummary(portfolios, main = "시점선택 VS 동적자산배분")
Tactical$net = Tactical$returns - Tactical$turnover*fee
cbind(Tactical$net, GDAA$net) %>%
setNames(c('Tactical Fee', 'GDAA Fee')) %>%
charts.PerformanceSummary(main = ' Tactical vs GDAA')
cbind(Tactical$returns, Tactical$net) %>%
setNames(c('No Fee', 'After Fee')) %>%
charts.PerformanceSummary(main = 'Tactical')
cbind(Tactical$net, GDAA$net) %>%
setNames(c('Tactical Fee', 'GDAA Fee')) %>%
charts.PerformanceSummary(main = ' Tactical vs GDAA')
GDAA$net
GDAA$net = GDAA$returns - GDAA$turnover*fee
cbind(GDAA$returns, GDAA$net) %>%
setNames(c('No Fee', 'After Fee')) %>%
charts.PerformanceSummary(main = 'GDAA')
cbind(Tactical$net, GDAA$net) %>%
setNames(c('Tactical Fee', 'GDAA Fee')) %>%
charts.PerformanceSummary(main = ' Tactical vs GDAA')
GDAA$net
GDAA = Return.portfolio(rets, wts, verbose = TRUE)
charts.PerformanceSummary(GDAA$returns, main = '동적자산배분')
portfolios = na.omit(cbind(GDAA$returns, Tactical$returns)) %>%
setNames(c('동적 자산 배분', '시점 선택 전략'))
charts.PerformanceSummary(portfolios, main = "시점선택 VS 동적자산배분")
fee = 0.0030
GDAA$net = GDAA$returns - GDAA$turnover*fee
cbind(GDAA$returns, GDAA$net) %>%
setNames(c('No Fee', 'After Fee')) %>%
charts.PerformanceSummary(main = 'GDAA')
GDAA$net
GDAA$returns
GDAA$net = GDAA$returns - GDAA$turnover*fee
GDAA$turnover = xts(
rowSums(abs(GDAA$BOP.Weight -
timeSeries::lag(GDAA$EOP.Weight)),
na.rm = TRUE),
order.by = index(GDAA$BOP.Weight))
chart.TimeSeries(GDAA$turnover)
fee = 0.0030
GDAA$net = GDAA$returns - GDAA$turnover*fee
cbind(GDAA$returns, GDAA$net) %>%
setNames(c('No Fee', 'After Fee')) %>%
charts.PerformanceSummary(main = 'GDAA')
cbind(Tactical$net, GDAA$net) %>%
setNames(c('Tactical Fee', 'GDAA Fee')) %>%
charts.PerformanceSummary(main = ' Tactical vs GDAA')
cbind(Tactical$net, GDAA$net) %>%
setNames(c('Tactical after Fee', 'GDAA after Fee')) %>%
charts.PerformanceSummary(main = ' Tactical vs GDAA')
### 성과분석--------
library(PerformanceAnalytics)
## 함수 없이 구해보기
# 수익률
chart.CumReturns(Tactical$returns)
cbind(Tactical$net, GDAA$net) %>%
setNames(c('Tactical after Fee', 'GDAA after Fee')) %>%
charts.PerformanceSummary(main = ' Tactical vs GDAA')
## 함수 없이 구해보기
# 수익률
chart.CumReturns(Tactical$returns)
# 누적 수익률
prod((1+Tactical$returns)) - 1
# 연율화 수익률(산술)
mean(Tactical$returns) * 252
# 연율화 수익률(기하)
(prod((1+Tactical$returns)))^(252 / nrow(Tactical$returns)) - 1
# 연율화 변동성
sd(Tactical$returns) * sqrt(252)
#### 낙폭과 최대낙폭
table.Drawdowns(Tactical$returns)
maxDrawdown(Tactical$returns)
chart.Drawdown(Tactical$returns)
#### 연도 별 수익률
apply.yearly(Tactical$returns, Return.cumulative) %>% head()
library(lubridate)
library(tidyr)
library(ggplot2)
#### 연도 별 수익률
apply.yearly(Tactical$returns, Return.cumulative) %>% head()
R.yr = apply.yearly(Tactical$returns, Return.cumulative) %>%
fortify.zoo() %>%
mutate(Index = year(Index)) %>%
gather(key, value, -Index) %>%
mutate(key = factor(key, levels = unique(key)))
ggplot(R.yr, aes(x = Index, y = value, fill = key)) +
geom_bar(position = "dodge", stat = "identity") +
ggtitle('Yearly Return') +
xlab(NULL) +
ylab(NULL) +
theme_bw() +
scale_y_continuous(expand = c(0.03, 0.03)) +
scale_x_continuous(breaks = R.yr$Index,
expand = c(0.01, 0.01)) +
theme(plot.title = element_text(hjust = 0.5,
size = 12),
legend.position = 'bottom',
legend.title = element_blank(),
legend.text = element_text(size=7),
axis.text.x = element_text(angle = 45,
hjust = 1, size = 8),
panel.grid.minor.x = element_blank() ) +
guides(fill = guide_legend(byrow = TRUE)) +
geom_text(aes(label = paste(round(value * 100, 2), "%"),
vjust = ifelse(value >= 0, -0.5, 1.5)),
position = position_dodge(width = 1),
size = 3)
apply.yearly(Tactical$returns, Return.cumulative)
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
SYP
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
symbols
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
SPY
UpsideFrequency(Tactical$returns, MAR = 0)
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
apply.monthly(Tactical$returns, Return.cumulative)
SPY
head(SPY)
head(SPY$SPY.Adjusted)
spy_ad <- SPY$SPY.Adjusted
apply.monthly(spy_ad, Return.cumulative)
Tactical$returns
spy_ad
spy = do.call(cbind,
lapply(SPY, function(x) Ad(get(x))))
SPY
Tactical
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
length(Tactical)
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
ncol(Tactical)
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
ncol(Tactical$returns)
Tactical$returns
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
nrow(Tactical$returns)
nrow(spy_ad)
nrow(SPY)
getSymbols(symbols, src = 'yahoo')
nrow(SPY)
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
nrow(Tactical$returns)
spy = do.call(cbind,
lapply(SPY, function(x) Ad(get(x))))
spy = do.call(cbind,
lapply(symbols, function(x) Ad(get(x))))
spy
spy <- spy$SPY.Adjusted
spy
nrow(SPY)
Return.cumulative(spy)
apply.monthly(spy, Return.cumulative)
apply.monthly(Tactical$returns, Return.cumulative)
apply.monthly(spy, Return.cumulative)
apply.monthly(Tactical$returns, Return.cumulative)
apply.monthly(spy, Return.cumulative)
## 승률: 포트폴리오가 벤치마크 대비 높은 성과를 기록한 기간 비율
# (포트폴리오>벤치마크) 일수 / 전체 기간
UpsideFrequency(Tactical$returns, MAR = 0)
roll_12 = Tactical$returns %>% apply.monthly(., Return.cumulative) %>%
rollapply(., 12, Return.annualized) %>% na.omit() %>%
UpsideFrequency()
roll_24 = Tactical$returns %>% apply.monthly(., Return.cumulative) %>%
rollapply(., 24, Return.annualized) %>% na.omit() %>%
UpsideFrequency()
roll_36 = Tactical$returns %>% apply.monthly(., Return.cumulative) %>%
rollapply(., 36, Return.annualized) %>% na.omit() %>%
UpsideFrequency()
roll_win = cbind(roll_12, roll_24, roll_36)
print(roll_win)
Tactical$returns %>% apply.monthly(., Return.cumulative) %>%
rollapply(., 12, Return.annualized) %>% na.omit() %>%
fortify.zoo() %>%
ggplot(aes(x = Index, y = portfolio.returns)) +
geom_line() +
geom_hline(aes(yintercept = 0), color = 'red') +
xlab(NULL) + ylab(NULL)
